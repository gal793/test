import org.junit.jupiter.api.extension.*;
import java.time.Duration;

public class ScenarioTimeoutExtension implements BeforeTestExecutionCallback, AfterTestExecutionCallback {

    private static final long TIMEOUT_SECONDS = 90;

    private final ThreadLocal<Thread> testThread = new ThreadLocal<>();

    @Override
    public void beforeTestExecution(ExtensionContext context) {
        Thread current = Thread.currentThread();
        testThread.set(current);

        new Thread(() -> {
            try {
                Thread.sleep(TIMEOUT_SECONDS * 1000);
                if (current.isAlive()) {
                    System.err.println("[TIMEOUT] Scenario exceeded " + TIMEOUT_SECONDS + "s — interrupting.");
                    current.interrupt();  // это вызовет исключение в степах, если те ждут
                }
            } catch (InterruptedException ignored) { }
        }).start();
    }

    @Override
    public void afterTestExecution(ExtensionContext context) {
        testThread.remove();
    }
}
